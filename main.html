<!doctype html>
<html lang="ko">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>계란 할인 정보</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Noto Sans KR', 'Apple SD Gothic Neo', Arial, sans-serif;
      margin: 24px;
      color: #222;
    }

    h1 {
      font-size: 22px;
      margin-bottom: 8px;
    }

    .today {
      color: #333;
      margin-bottom: 4px;
    }

    .card {
      border: 1px solid #eee;
      border-radius: 8px;
      padding: 16px;
    }

    .row {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .promotion-items {
      display: inline-block;
      white-space: nowrap;
      /* 텍스트 줄바꿈 방지 */
    }

    .label {
      display: inline-block;
      width: 90px;
      color: #555;
    }

    .error {
      color: #c62828;
      font-weight: 600;
    }

    .toggles {
      display: grid;
      grid-template-columns: 1fr;
      /* 1열로 정렬 (세로 정렬) */
      gap: 16px;
      /* 토글 그룹 간격 */
    }

    .toggle-group {
      display: flex;
      flex-direction: row;
      /* 버튼 + 출력 부분이 한 줄로 정렬 */
      align-items: center;
      justify-content: flex-start;
      /* 출력 부분은 버튼 오른쪽으로 */
      gap: 16px;
      /* 버튼과 출력 데이터 간 간격 */
      width: 100%;
      /* 옵션: 원하는 레이아웃 비율을 안정적으로 설정 가능 */
    }

    .toggle {
      padding: 8px 16px;
      border-radius: 5px;
      border: 1px solid #ddd;
      background-color: #f9f9f9;
      font-size: 18px;
      min-width: 120px;
      /* 버튼 기본 너비 */
      text-align: center;
    }

    .list {
      white-space: pre-wrap;
      /* 줄바꿈 유지 */
      margin: 0;
      /* 상하 마진 제거 */
      padding: 8px;
      border: 1px solid #eee;
      border-radius: 5px;
      background: #fff;
      font-size: 16px;
      color: #444;
      width: 50%;
      /* 가변 레이아웃 */
    }

    .loading {
      color: #0d64c7;
      margin: 9px 0;
      font-weight: bold;
    }
/* 컨테이너 초기화 */
.container {
  display: flex;
  justify-content: space-between;
  width: 100%;
  gap: 20px;
  padding: 20px;
}

/* 각각의 절반 섹션 스타일 */
.half-section {
  flex: 1;
  padding: 15px;
  background-color: #f9f9f9;
  border: 1px solid #ddd;
  border-radius: 10px;
  box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
}

/* 최저가 강조 스타일 */
.highlight {
  font-weight: bold;
  color: #0d64c7;
  font-size: 18px;
  margin-bottom: 10px;
}

/* 리스트 스타일 */
.product-list {
  list-style-type: none;
  padding: 0;
  margin: 10px 0 0 0;
}

.product-list li {
  padding: 8px;
  margin-bottom: 5px;
  background-color: #fff;
  border: 1px solid #ddd;
  border-radius: 5px;
}

.product-list li:nth-child(odd) {
  background-color: #f3f3f3;
}

  </style>
</head>

<body>
  <h1>오늘 계란 할인 정보</h1>
  <div class="today" id="todayText"></div>
  <div id="loadingMsg" class="loading">⌛페이지가 로딩중입니다. 잠시만 기다려주세요.(10초 이상 기다려주세요.)
    <span id="loadingTimer"></span>
  </div>
  <br>

  <div class="toggles">
    <div class="toggle-group">
      <button class="toggle" data-mart="homeplus">홈플러스</button>
      <div id="homeplusData" class="list"></div>
    </div>
    <div class="toggle-group">
      <button class="toggle" data-mart="emart">이마트</button>
      <div id="emartData" class="list"></div>
    </div>
    <div class="toggle-group">
      <button class="toggle" data-mart="lottemart">롯데마트</button>
      <div id="lottemartData" class="list"></div>
    </div>
  </div>
  <br>
  <hr>
  <br>

  <div class="container">
    <!-- 왼쪽 영역: 대란 -->
    <div class="half-section" id="left-section">
      <h2>대란</h2>
      <p class="highlight">최저가👉 <span id="lowProductMiddleEgg"></span></p>
      <ul id="middleEggList" class="product-list"></ul>
    </div>

    <!-- 오른쪽 영역: 특란 -->
    <div class="half-section" id="right-section">
      <h2>특란</h2>
      <p class="highlight">최저가👉 <span id="lowProductBigEgg"></span></p>
      <ul id="BigEggList" class="product-list"></ul>
    </div>
  </div>

  <script>
    /*
    ~예시) 홈플러스 동작 흐름~
    DOMContentLoaded 에서 이벤트가 발생하면 즉시 fetchHomeplusData 호출
    fetch('/api/homeplusData')를 통해 서버에 요청을 보내 response.json() 데이터를 받아옴
    받아온 데이터를 renderHomeplusData 로 전달하여 데이터를 html에 표시
    */

    const allItems = []; // 값 비교를 위한 전체 데이터 모음

    function renderHomeplusData(data, targetDivHomeplus) {

      // 데이터 렌더링 처리
      data.forEach(item => {
        const promotionItem = document.createElement("div"); // 각 데이터 출력을 위한 div 생성
        promotionItem.className = "promotion-items"; // 클래스 이름 설정

        // 데이터 필드 추출 및 처리
        const title = item.title || ''; // 제목이 공백일 경우 빈칸으로 처리
        const price = item.price ? new Intl.NumberFormat('en-US').format(item.price) : ''; // 가격이 공백일 경우 빈칸으로 처리
        const discountRate = item.discountRate ? ` (${item.discountRate})` : ''; // 할인율이 공백일 경우 괄호를 생략
        const comment = item.comment || ''; // 코멘트가 공백일 경우 생략
        // const promotionPeriod = item.promotionPeriod || ''; // 행사 기간이 공백일 경우 생략

        // 출력 텍스트 생성
        let displayText = title; // 필수 필드: 제목

        if (price) { displayText += ` / ${price}원 ${discountRate}`; } // 가격 추가
        if (comment) { displayText += ` / ${comment}`; } // 코멘트 추가
        // if (promotionPeriod) {displayText += ` / ${promotionPeriod}`;} // 행사 기간 추가

        allItems.push({ mart: "홈플러스", title, price }); // 값 비교를 위한 전체 데이터 모으기

        // 최종 텍스트를 div에 설정
        promotionItem.textContent = displayText;

        // `targetDiv`에 새로운 데이터 추가 (기존 내용 유지)
        targetDivHomeplus.appendChild(promotionItem);

        // 줄바꿈 태그 추가
        const lineBreak = document.createElement('br');
        targetDivHomeplus.appendChild(lineBreak);
      });
    }

    async function fetchHomeplusData(targetDivHomeplus) {
      try {
        // API 요청 수행
        const response = await fetch('/api/homeplusData');

        // 응답상태 코드 및 ok상태 확인
        // console.log("응답 상태 코드:", response.status); // HTTP 상태 코드 출력 (200, 404, etc.)
        // console.log("response.ok:", response.ok); // 상태 코드가 200~299 사이인지 확인

        if (!response.ok) {
          throw new Error(`네트워크 응답 실패 (상태 코드: ${response.status})`);
        }

        // 서버의 원본 응답 데이터 확인
        const responseText = await response.text();
        //console.log("서버 응답 데이터 (원본):", responseText);

        // JSON 변환 
        const data = responseText ? JSON.parse(responseText) : {};
        //console.log("JSON으로 변환된 데이터:", data);

        // 데이터 추출
        const formattedData = Array.isArray(data) ? data : [];
        console.log("렌더링에 사용될 홈플러스 데이터:", formattedData);

        // 렌더링 함수 호출
        renderHomeplusData(formattedData, targetDivHomeplus);
      } catch (error) {
        // 오류 처리
        const errorMessage = document.createElement("span");
        errorMessage.style.color = "red";
        errorMessage.textContent = "데이터를 불러오는 도중 문제가 발생했습니다.";
        targetDivHomeplus.appendChild(errorMessage);
        console.error("마트 데이터를 불러오는 중 오류 발생:", error);
      }
    }

    function renderEmartData(data, targetDivEmart) {

      // 데이터 렌더링 처리
      data.forEach(item => {
        const promotionItem = document.createElement("div"); // 각 데이터 출력을 위한 div 생성
        promotionItem.className = "promotion-items"; // 클래스 이름 설정

        // 데이터 필드 추출 및 처리
        const title = item.title || ''; // 제목이 공백일 경우 빈칸으로 처리
        const price = item.price || ''; // 가격이 공백일 경우 빈칸으로 처리
        const discountRate = item.discountRate ? ` (${item.discountRate}%)` : ''; // 할인율이 공백일 경우 괄호를 생략
        const comment = item.comment || ''; // 코멘트가 공백일 경우 생략
        // const promotionPeriod = item.promotionPeriod || ''; // 행사 기간이 공백일 경우 생략

        // 출력 텍스트 생성
        let displayText = title; // 필수 필드: 제목

        if (price) { displayText += ` / ${price} ${discountRate}`; } // 가격 추가
        // if (comment) {displayText += ` / ${comment}`;} // 코멘트 추가
        // if (promotionPeriod) {displayText += ` / ${promotionPeriod}`;} // 행사 기간 추가

        allItems.push({ mart: "이마트", title, price }); // 값 비교를 위한 전체 데이터 모으기

        // 최종 텍스트를 div에 설정
        promotionItem.textContent = displayText;

        // `targetDiv`에 새로운 데이터 추가 (기존 내용 유지)
        targetDivEmart.appendChild(promotionItem);

        // 줄바꿈 태그 추가
        const lineBreak = document.createElement('br');
        targetDivEmart.appendChild(lineBreak);
      });
    }

    async function fetchEmartData(targetDivEmart) {
      try {
        // API 요청 수행
        const response = await fetch('/api/emartData');

        if (!response.ok) {
          throw new Error(`네트워크 응답 실패 (상태 코드: ${response.status})`);
        }

        // 서버의 원본 응답 데이터 확인
        const responseText = await response.text();
        // console.log("서버 응답 데이터 (원본):", responseText);

        // JSON 변환 
        const data = responseText ? JSON.parse(responseText) : {};
        // console.log("JSON으로 변환된 데이터:", data);

        // 데이터 추출
        const formattedData = Array.isArray(data) ? data : [];
        console.log("렌더링에 사용될 이마트 데이터:", formattedData);

        // 렌더링 함수 호출
        renderEmartData(formattedData, targetDivEmart);
      } catch (error) {
        // 오류 처리
        const errorMessage = document.createElement("span");
        errorMessage.style.color = "red";
        errorMessage.textContent = "데이터를 불러오는 도중 문제가 발생했습니다.";
        targetDivEmart.appendChild(errorMessage);
        console.error("마트 데이터를 불러오는 중 오류 발생:", error);
      }
    }

    function renderLottemartData(data, targetDivLottemart) {

      // 데이터 렌더링 처리
      data.forEach(item => {
        const promotionItem = document.createElement("div"); // 각 데이터 출력을 위한 div 생성
        promotionItem.className = "promotion-items"; // 클래스 이름 설정

        // 데이터 필드 추출 및 처리
        const title = item.title || ''; // 제목이 공백일 경우 빈칸으로 처리
        const price = item.price || ''; // 가격이 공백일 경우 빈칸으로 처리
        // const discountRate = item.discountRate ? ` (${item.discountRate}%)` : ''; // 할인율이 공백일 경우 괄호를 생략
        const comment = item.comment || ''; // 코멘트가 공백일 경우 생략
        // const promotionPeriod = item.promotionPeriod || ''; // 행사 기간이 공백일 경우 생략

        // 출력 텍스트 생성
        let displayText = title; // 필수 필드: 제목

        if (price) { displayText += ` / ${price}`; } // 가격 추가
        if (comment) { displayText += ` / ${comment}`; } // 코멘트 추가
        // if (promotionPeriod) {displayText += ` / ${promotionPeriod}`;} // 행사 기간 추가

        allItems.push({ mart: "롯데마트", title, price }); // 값 비교를 위한 전체 데이터 모으기

        // 최종 텍스트를 div에 설정
        promotionItem.textContent = displayText;

        // `targetDiv`에 새로운 데이터 추가 (기존 내용 유지)
        targetDivLottemart.appendChild(promotionItem);

        // 줄바꿈 태그 추가
        const lineBreak = document.createElement('br');
        targetDivLottemart.appendChild(lineBreak);
      });
    }

    async function fetchLottemartData(targetDivLottemart) {
      try {
        // API 요청 수행
        const response = await fetch('/api/lottemartData');

        if (!response.ok) {
          throw new Error(`네트워크 응답 실패 (상태 코드: ${response.status})`);
        }

        // 서버의 원본 응답 데이터 확인
        const responseText = await response.text();
        // console.log("서버 응답 데이터 (원본):", responseText);

        // JSON 변환 
        const data = responseText ? JSON.parse(responseText) : {};
        // console.log("JSON으로 변환된 데이터:", data);

        // 데이터 추출
        const formattedData = Array.isArray(data) ? data : [];
        console.log("렌더링에 사용될 롯데마트 데이터:", formattedData);

        // 렌더링 함수 호출
        renderLottemartData(formattedData, targetDivLottemart);
      } catch (error) {
        // 오류 처리
        const errorMessage = document.createElement("span");
        errorMessage.style.color = "red";
        errorMessage.textContent = "데이터를 불러오는 도중 문제가 발생했습니다.";
        targetDivLottemart.appendChild(errorMessage);
        console.error("마트 데이터를 불러오는 중 오류 발생:", error);
      }
    }


    // 요일 계산 함수 (요일을 한국어로 반환)
    function getDayInKorean(dayIndex) {
      const daysKor = ["일요일", "월요일", "화요일", "수요일", "목요일", "금요일", "토요일"];
      return daysKor[dayIndex];
    }

    // 오늘날짜 및 로딩 타이머 설정
    function initializeDateAndTimer() {
      // 오늘 날짜 설정
      const today = new Date();
      const todayTextElement = document.getElementById('todayText');
      const dayKor = getDayInKorean(today.getDay()); // 오늘 요일 (ex: 월요일, 화요일)
      todayTextElement.textContent = `☘️오늘 날짜: ${today.getFullYear()}년 ${today.getMonth() + 1}월 ${today.getDate()}일 (${dayKor})`;

      // 로딩 타이머
      let counter = 0;
      const loadingTimerElement = document.getElementById('loadingTimer');
      const timerInterval = setInterval(() => {
        counter++;
        loadingTimerElement.textContent = ` (${counter}초)`;
      }, 1000);

      return timerInterval;
    }

    // 전체 상품 가격 비교해서 최저가 찾기
    function displayLowestPriceProducts(products, isSpecial, lowProductId, listId) {
      // "특란" 또는 "특" 포함 여부에 따라 상품 필터링
      const filteredProducts = products.filter(product => {
        const title = product.title || "";

        if (isSpecial) {
          // "특"이나 "특란" 포함된 상품
          return title.includes("특란") || title.includes("특");
        } else {
          // "특"이나 "특란"이 포함되지 않은 상품 (즉, 대란)
          return !title.includes("특란") && !title.includes("특");
        }
      });

      // console.log(`${isSpecial ? "[특란]" : "[대란]"} 필터 결과: ${filteredProducts.length}개`);
      // filteredProducts.forEach(p => console.log(`  - ${p.mart} | ${p.title} | ${p.price}`));

      // 필터링된 상품이 없을 경우
      if (filteredProducts.length === 0) {
        console.warn(`${isSpecial ? "특란" : "대란"} 관련 상품이 없습니다.`);
        document.getElementById(lowProductId).textContent = "상품 없음";
        return;
      }

      // 가격 기준으로 오름차순 정렬
      const sortedProducts = filteredProducts.sort((a, b) => {
        const priceA = parseInt(a.price.replace(/[^0-9]/g, ''), 10);
        const priceB = parseInt(b.price.replace(/[^0-9]/g, ''), 10);
        return priceA - priceB;
      });

      // "홈플러스" 상품의 가격만 표시 형식 수정
      sortedProducts.forEach(product => {
        // 가격 문자열에서 숫자만 추출
        const numericPrice = parseInt(product.price.replace(/[^0-9]/g, ''), 10);

        // 조건: "홈플러스" 상품에 대해 적용
        if (product.mart === "홈플러스") {
          // 3자리마다 쉼표 추가 및 "원" 붙이기
          product.price = `${numericPrice.toLocaleString()}원`;
        }
      });

      // 최저가 상품 (첫 번째 항목)
      const lowestProduct = sortedProducts[0];

      // 최저가 상품 HTML 업데이트
      updateHTMLElement(lowProductId, lowestProduct);

      // 목록에 정렬된 상품들 출력
      appendProductsList(listId, sortedProducts);
    }

    // HTML 요소에 값을 업데이트하는 함수
    function updateHTMLElement(elementId, product) {
      // 지정된 HTML 요소에 텍스트 업데이트
      const element = document.getElementById(elementId);
      if (element && product) {
        element.textContent = `[${product.mart}] ${product.title} / ${product.price}`;
      }
    }

    function appendProductsList(listId, products) {
      const listElement = document.getElementById(listId);
      listElement.innerHTML = ""; // 기존 내용 초기화

      products.forEach(product => {
        const listItem = document.createElement("li");
        listItem.textContent = `[${product.mart}] ${product.title} / ${product.price}`;
        listElement.appendChild(listItem);
      });
    }

    // DOMContentLoaded 이벤트: 페이지 로드 시 실행
    document.addEventListener('DOMContentLoaded', async () => {

      // 날짜, 타이머 호출
      const timerInterval = initializeDateAndTimer();

      // 데이터 로딩
      const targetDivHomeplus = document.getElementById('homeplusData');
      const targetDivEmart = document.getElementById('emartData');
      const targetDivLottemart = document.getElementById('lottemartData');

      // 데이터 가져오기
      await fetchHomeplusData(targetDivHomeplus);
      await fetchEmartData(targetDivEmart);
      await fetchLottemartData(targetDivLottemart);

      // console.log('--확인용--');
      // console.log(allItems);

      // 대란 정보 표시
      displayLowestPriceProducts(allItems, false, "lowProductMiddleEgg", "middleEggList");

      // 특란 정보 표시
      displayLowestPriceProducts(allItems, true, "lowProductBigEgg", "BigEggList");

      const loadingMessageElement = document.getElementById('loadingMsg');
      loadingMessageElement.textContent = "🔽 아래 정보를 확인해주세요.";
      clearInterval(timerInterval); // 타이머 중지
    });

  </script>
</body>

</html>